package dittner.gsa.backend.encryption {
import com.hurlant.crypto.Crypto;
import com.hurlant.crypto.hash.SHA256;
import com.hurlant.crypto.symmetric.ICipher;
import com.hurlant.crypto.symmetric.IPad;
import com.hurlant.crypto.symmetric.IVMode;
import com.hurlant.crypto.symmetric.NullPad;
import com.hurlant.util.Base64;
import com.hurlant.util.Hex;

import dittner.gsa.bootstrap.walter.WalterProxy;

import flash.events.TimerEvent;
import flash.utils.ByteArray;
import flash.utils.Timer;

public class EncryptionService extends WalterProxy implements IEncryptionService {

	private static const RANDOM_TEXT:String = "508217a80201034082176f06092a864886f70d010701a08217600482175c308217583a820c8f06092a864886f70d010706a0820c8030820c7c02010030820cf506092a864886f70d010701301c060a2a864886f70d010c0106300e04083d3425118ab3f0a10202080080820c483af405781135b70aafbb19f58f974a288e44574d33298ae60a7d2a931e1e7bc7730f959ae0ef4dd271d7c0a483e03bd83d79da52a3d3cb90d95a4570935a8af2c39e1b8993392a9f51076cb247f8266427080a1ac17931d9a0c67beef460f3fdb8639b0db8bee718ff6face8c2d587ccf44d5f8101983f65176610cc15a9a5f398cb737a1a9b1dd18be3f2aef7f116401d57864ff124cdacdc39df703f9fc0476d209edb97f7787d91fb0cbc6442ce1a28df7132eeb3db573f8de77718f8a4855cd69073ec83386962b535e412842a238db4fabd48ca0d7de6a6fe6ba99896cfcd325111382854c02bf2d72884425ede9c4177cf238ca0d2badfb2362744b8c53918a0d85f3af9936b603a18109caa9fba87c84cef00374a9bde6f6f77edf3ff63151641a2d58434a17caa5c75c51b575838220e92d215d2c5d01af2e89c1b70fe2acb956ec640694100c833450d8193fd659be52f67dbd347c64aa1826a25f9dd61157cf812ba26598e11d15ebe25174c4536ca41199eb9e562d67d481bf674ffdcf6395027eb2ffb92d4d545137a6b5e51cc8994d5803e32fb749ba4b4e8d392292d3d1e295b122f156342c963d24b0de3052e024c993ae61ffae0d36eeeb02fb42f2c1b2c5576979a266369162e2b65997add00b45e7a07dbce65933d6e74999efd1502e5eb7c089b7be37ef0952323f74968922957c7c2fe3bb286231b9850308c260867b30eb790a0a382ab6f32ca577e07e9a8a8d687c1ceae6e4fc0a9a0487e17d0657e70e287ccd5433068cf8096f1bf15c6bc65c8f616653f731b20b42e068906c2707c7155782e1e4650417777917395a88c6cfc1fdfd4a8bb7bbfbcfdefd5f2bdcc7f21cd2423fb40516f73c224a6d46a3f3971d71ab1f9beb646e0b9236298e20550f6a115dabf32924a044e01c40c984e1dc7855341d35928dafdfae2d1241d16393c6abe51ed09e05760296f57c6ab067efdfefedf35575a663f8cb410b54897cd05de5f6edc5d95784df8ddf787df9a40a952308a97f89c4a00337ddd2f9d342abed394c9a05a0b8f3c100484482891d72029b25702c93fe0bf31b6428ea8fe1df37c51f01027b3d960920357b0383cb5c70db27a9610369ee4fc682e330b1997e8e80c666fc56d3e5798d3fcdc6d3f0b1031def4c94cc09a1137a3d5b9f3f8cd7aec7fbdb9569cd54195f8ee7d884ae4aa98eb4ecfd45b011c524419d7335225793730cd783dbac10a10d18ae1bb98aa2671cff0e861b8f6a2afab447c73dfa9eefffe457b1c0b0034ab3f25e04a395d8f1d90adaacfac9277eeec23c273ebacd525cf44123583f638d77433c7422d7e07b215a62a747174c29a9bdc13d962f268b4c94e74cc806d998bf26652c288a65a4f135e5bce6cebc3f0003020b0e5a9624c3bb24379358203a6e76fe80abec84a85f1f1ee6dc1a6803aba5cec2bc26cfa5f4242df0567c126452032e17660c2a07c5ff7c56e031291afff0c10ef2bb58b4ef8db08d76649fd6093ab9a6025f2a9ed56c7fd6b370e2a831237692592aa016ff7acddb4d1b08b52312a6ffa52a2ceeb05895a2be04451a039dab0f72c700c5e68e70fd7ae447a1fdd1e936527b492e6903df1a42e4a64031d59294d76b3b1eb5d54ad784a3352ef3c2d12d547a38fa24a9eba01b9f433878eb2f51164306f9ba19eac2945c9033164f94481bae8e0e8e569a9fa97ab00a44d7cc51bf8aa4157d247bbdc17cbf44ec11a108fc87c377f843b5572b2521138752cfbcb254743860d7415ea9189d4725511f0d1ff56ddc2d89aa7af4e2e4f08fc32c2e70832936fc753cf7edd64868bbc322c86ac72bba877d0286894ce1df5df427f57b21ce026918cfa6fa1d3fec7d9b4b13d0abccae1aa86bbd20d8ca2f88c883eb56e7f9d168fce4643f44f805ec0fb22d8dc53ef44e19635b9ec1ebce797f5e9b2d9eb29214eb233876f8bf8bad5b8074daaeb59c9f9c537e46905a4c9fa99383229b040b102021ee10d4be053b46719c8e0077ebb541c7d2e7ba640bb4b65902b2632d5d01a1d1075699f095a52cb46e3f5b7a9f87364ceec096773a83140bb1c14b8ef236a1ce812c863c174419d1a9361b0c0b90294e5e562a9fa5222ff95dd92ee27bd57ed69554ab04d0d58b61bda474e137dc01a7858bcf955890249560bb6f24be35cbb22ad73d93dcaf666afd818d6bd11d9c12eceec80828c2bb0e3666f859aa459505d74a7046c1bb74ea1879f65c4c64757920642fa5b031b3ecde736d1c0017157e7cbc9f057849dac66edf580ac4aa7b670f302434513be249fe5ccb6b865bcd11bd9a7ba99f07695791b024e34706b59f1e48fab2496a45c7ead5ba0a1de4ac1476884035559355cee4bf4449c0002a53e611916c6b0c7cee8f03a8fe37167628d900e28dbb98a410190347753e12ae97b3f4cbb90180e9e2eabf92ed288e4f24bc0b33fe5dcd2dfed78c411535c3cbb2ce9d7126c7001704576389ec7c7fe1e03843e87a29b3b3721c42ea4b7d94491376ed1ad8219014b23e5b0abf2e9937c1e5cea7ab6b396437bc599d21ffc0f1b3ffc82338313f0bb5ca5c933ac76a13096be9f170734ef8b6a23c43dc7f54db9f4c751eff51ac0f3206b9c90c944ece1cd613c74f0d301e8896f10e1951003c7c2608ba64f972461a47fee4bd6849399073b232dcf80827eb18f0327fb1392fb53669cd150cb06ac041e574834df927d76687a2a513879141818901da72ebe99402a99305fc6dc9cef0ea2e697094de471a4ae36fac1fc341dead6e8a161dfbc13478cb3c620f291065a98067c65f88d8328bac47b0282f226b15fe3f4b61bc321878128537bcba87989bf89b20daf2d8df337476e64847e1801f3d0b4e51457209e0f19fdfe36ba795285ba7165e306c2a79804821fcd5674d3c0c367e463a4980c2d10fa31a6f4a4f54bc5fa11bfa86eb708f5029146379c009187ed61079b73364d6f47bc52cdf4953c807e88971918f3232d3e21a3bdc7afc7a621d879108c9f0b11ef58a2d219a620e3e9ff8a2d0bb82159a6fe091e6dc2f398550b1a2d627cfa5565a80d415384cfe1b6d8da394eb5e08ad91338c80abbb959b8faa09867e6f5dbd807c18f66ad01067fc16590a885834aaf9d079634ad03793959679a7a9a5dcabb3d63d79e39ba830de2deb00dd7d41ed7a65ada4f2fedbb3034dee7b5734626fae7a847fc38253820c197f212437e1cf684ff2773ae89764c39d13f2b4638eb26684b4cadd76ddbad91bef1410898dd969fa8fdce4154b9bb04eb7eb27847e0aa0497edd83acf6643cc49974a9b07c9b95bf57216e311326a1ccf4f698551ad60577381432af0f07e9a094e9bba2704be37b0773ea9107862eb987d28e9d26845f03402e847009dc7546dccc6de9c1f54160867ca27b036f32ffe899579b3451bdbd77ce68840b908a6c155b24c5869fa0964d839a0cd14202a03608bc0b0f3acd747e6024f274e0ca1dd7c4624f2f76e224fc22e164e71e3d980909e69e01c77daac1f1f347cdadf4b30738225d952882ba407ecc9c1c315da9581a304e873b83a47cb5f33cff9396ca63a94766b165101f45d5bb47f8a0402955472534b9c554295d4661056805603a52deea16212b569f5599d73c586c9e737632a22744a14ddc95e392caa4ebcb76b46f3599a7484a9844745978bd295663d0d58e35a9ed77a197378b376a9c17d24da98d3207660869901d9b428332aba3f266ac058112ebd56fc31ba9c7d0e60a77e4b43ec64b56c65086d7c25badcf57e2eb76e6eb0c602050059de8311917f917afc20094f798771a3361712a29575317fef2f736f3be1fcb2229f2417dba20406aa3856fbd4bdd250114e50a611a9a730aab8a5d194c40ba37b1714d67973bd6832ee9d75a3f01cbf586f98e94ac2d5207444c78d14843c78d541e75c7d9f8f201a0d0ec16ace6774808fb42cadf21753e607c635496118c38ca2a783fcc0a0092ec3e016b27f0fcc86d79a582207130e61d7415dd516d4d2d3eb4f41fb466292469d37b493ffc89ced8717119b0ef71e6bbc77e805b1fe4720b8be94444d62412db1b7dcb407badbbff339c511e47b5c95ad87a35b33899a56e83e9da45b4ffad2e7e2f4df1385a6f5df061fba7acc2004946dd8c0860ff84a6beada392b228a80176ba19a682a2726d8c400439bce9ebc8405b58c9be3fa7a8ee3d6332baf3f620a83ca090054207014a1229a490341ec805da0478a65663e661e7e198c88aed8b98b2e6eb5559100e3e04a66e627c209bec5b822e3cb2d31444fc2e29b8414bd78823795801ecdec653851249b80417135f3cbbf62cc902821a45c4186a04d90779743f350e44daf7ba0e445a36225a57dd80da83d3c706a4526c56b67096b0c2d8c9cef4de1538508ca534f77192892ae8aa05d0a5810534c71b130820ac106092a864886f70d010701a0820ab204820aae30820aaa30820551060b2a864886f70d010c0a0102a08204ee308204ea301c060a2a864886f70d010c0103300e04089fc72b7f3f827cda02020800048204c825110a9cd49331d62c3c0c8bb95e88dd13f9054ad563195f43409edec9249d860657a24925b2d5977c86b8985d5cc75ab2663a90b7347d6975e40dd39bf88eb97d1ae752946a1143805f332759da7702cce088986c753f330a7a975cc4c589d43fce5d0da2ce95fbc79fc14d5d05f8e4bea3635e24adc97c834fbbe8f51f6e8ac123ebc9271cd5b3db3f15e6b6935a8b4e0fff2f61ca28363b1300894a50ff513598ff38cf75ce5d3d9d8cf5cfbd795349e3df503813fb2bfd7b13c5e96336e406585d9a85595093e19c034cd612dd4609a238e30309e552512d8d2857aa85ca2f99f6da4739e3bc2945aba0170fb8f80d741f580c617eba2c6aec2947d3e3955b43cce4292815564121abeae8861890370084f10b84904976206686ed52725b60bff780ea953bfefd4fa754c16f9633021005e9436096376a6f443b7438e7b1f1fb7a93fc403e31068a5efeef3ec07eb026363f4bcb782a2d662b913cbd360f3d5f3d68fc63fd7c4390935cf601d14b33df78bd063c198627d68907c21fa08f7c928626900c614a459c1f9a8ba5983bef8b43fc6113aa50b38e5eda2892c2769c980d3204eaf480bc62cff4dfb1d3d945b9aaa5c6996b2fac0d6beda42aa97817fa6310eb147c97f5f3e2259f36a2826812bfdeb505b1c81a06dc982fbfe41f97e0c2ea3a233c502711064db9d1f7ff4d2e8490f6b4b485d8e1b32a21e3fca2f1c1d54f82f6de503040abc281d4d2f42df7e6b9532583e484977d65c3059637684cd381e58fe5b85c1eb354c3ca5b0ed55a0324526f06d5b9a11337082c3cfc923ed4820c87ad5a268661d19fa1e78c04a2abe352e2501bc1fbb54691bb24947b5e866eea33c1ed4dbff05d2802a5532ea9d1d3d153da75789a53b0a483254d4a50d6cd22c37c075aeef306b13e39163eb1af5e31f88103d94f00c2d5ecd312bef14ba0dbd47d86f5ece162235c924159c7e0dcac380936f1816202c514a1fa055e7f9a45ef48c29572f282b0f3a8970b77365f6dab1ef8c234171f0545917d286d3ca9619540df1d3065b49217c8f2221433a56e9321cd6fd44abbd992b25604dde1c0f1e03b43cf37ddfdcb3989baca182f20abbcf431fdabdaa48c2504b81d6dc23f47d9c4498a349880fe25a1e2abaa4a93753386622f196e34682cc22454f49b3bf41aaf2302480c1158d2d45ce1f0daf6368d026d3b3e52a123a530ffc576dc3b212a8fb0b3390a4b529800d0ca463b2ed439e6c3c0da4ffc1fd74523ede69bdb382b805848462f34534bca0d83bc051de43e1f019c139d260fb7a1dd9c4feb011e78cd3af7d340e39d2bb1039639b9268cf6f5416e9811b2004fe604fd247ef557a1be4b89f553f3b5c701ab4500a29291ce45336929e21efa3b3bf68b4619ae3354c7f2f15750590cd1fe0b93c9c0ac29013fd4bd126a70e8723941455e98f4c2df732dd6c9e263b962fe9018b89b8522ff60462bca8fa83048316f229a5fc82110f4d3edb08b994e0e643aa7e41cf517d67227338da52ecad68b0c2d9d142dcbc8749e40cb6986bbb37e54cecbaaf9501883caf3ee60cd6ea5d020c84eee44f1b9ab801fd9da37788c4c7441d33cadb37609a65e969b9acaabb635e3fbd8d41825149de851e9f8f29d4999bd56c57b0046b064b68bb42000636d0f16c3394f391b1b79e2a65ef0af9109047e8ad4e249256196cad0f633bc2a22ccf43efd1f514fe97f3150302906092a864886f70d010914311c1e1a004d0061006b00730069006d0020005000610076006c006f0076302306092a864886f70d01091531160414bac09fee0a454f03976c8afe0a969bee16b4704930820551060b2a864886f70d010c0a0102a08204ee308204ea301c060a2a864886f70d010c0103300e0408250ac2c44ce0284502020800048204c85f98734e1d25abadb2c493784de75bef00f2d3f2f02dff37c5ec841dfd8147782f657c9ace9b3ca991ac5474174ca35fa3c0e09bf2eca09e4766c986ae361bcc2cb27fdbdf64e269260dedef69012096aa1b8d6ae7f61699497308cd40145041dfb97105ff0b59116fe583d2e6eae65c6aa293f476e683b883a89b4b8bbda7fa1b286c7ddadc9fc7d874c45e542da5df7945f7d06ab6d54b9984113504e9b4e1dbca2343a84061ac08e95c01cef128fed7697fe881f6f249ad8632998f3263bec28007bbe8b44e02bc044c61abf5e5dacd06944f7f8c9262ca4b66a5551dbcd6da79e92e0ad7d32b7b42c7054bb9a01cdf15418d76c85f648e438794cc5c8fbbc8df07e6ccb7e5d09db3863b3bbd9669e367498ea61c354ca7383982286309af49b0fcb7ac30e746d735ba92d0f13a7d6783566839d3ea73d279f94f895e6a00b821b6a78171def355341d56e246c3d6202ac4c6bab96e87e874f308f3ccdf8f8b6f8cd8a9485acca87f957a3a3eddadd7b5b08c9796370726ca03fca097e5483db80de7a1d5be484dc311e7c4c44e7d7e0072ca665f332841c85aecc6a1e07a56cc8f6d39a3e65e3677c3935648f2f4e16442c6d0cadeefc9188d65bca9ab88e487299419694a106b3e2cd66b1db63acaa028e352688ca286cea98b08ed58ec3d6a41ae31dff5ce0445cbb1c84bdd4499b67428732828cc5ec78500b6ba8d6f584fa23cce13886e8580991747dc6f9544e891df2872e93bc59e6e7489bd73aaec7ca0cf8b04771bb1e57b7eb5c404f9f4d0ef078fc4cd2cc7f5ef614bf3e2e08a749d2d26fd916f3bfd9b5108a6a97e9e8abede53f7799568a084df580483d23611cb732ada229c4d42e1418d7c963ada1a94e7f8a29b49bac263e5737a3baa60a349bac5b659c4480a61958afb6080a341414a01fb9e8913d2fcf36a99e0cda671f9af7bd819a2c41ef63e5e147082d8bdb7207be1a558509fdb4f3262ddb59847d2676b3c9835ace8e5e131c6cc337b190e56c433aad8bf6f0c4a724db0d0895937fe76fe5f9b0d8415f245dc4881ed36705d5d7d8342828bb012232fc257f7835e151a1ec60853a98f12c6efd795f3d2c4ae80c4924bd41ceea6c1264721275dd7c8fa5efd1dce86c945d43258c984f75a18a55e27d2f2d1f8090b3b3052e6e95b667e21fafc70b715547dd4d2227a1cfaf921716bfa0906bb20d63c6020dedfeaeb2734400b21fc865e25e9118e21e0a78cd5580dcf01fa8aed0322636c753ea2d6e8be019984aba8194490bc2f4eb0c5a5bf0e31891fb69b08e98efc55d1231e7e0218668e588450a23ce2a83e6282aae37b696ba3b0e27c84f7670e5d899f8efc331e3603bd9f094704e92f38590701dcabe6ac46f89539cc6f25873ad5c68ecdc649a50837f184f19df312523d26b1c07887202973cac716d1a072b7979266d6d145dc3481cc8aadc2a510ce4844d399f13391febe6a03fdb5d2786d2514e0ebbe7ce81dbbcebe0155101b68a27435925c6b28085e705ac62d51ad7e218d140a430e7430e260e61545db3891747797645d3779efc621277e65755d2b913db6bb1c905cb0138804e840684ec7c75acdf060ea099b82901951573d0f6f7365ff67435d6a7e1195859b50162fffede34c2adfa45087f0ba835e701aae891bd7eebb52b4bd7bdff0d31a8dbdabf6f21190236d939c676a5e9e12068f6f502e51092e0edfde4e3150302906092a864886f70d010914311c1e2a004d0061006b00730069006d0020005000610076006c006f0076302306092a864886f70d01091531160414bac09fee0a454f03976c8afe0a969bee16b4704930303021300906052b0e03021a050004140842e66897239b5ef55bc40e1e877aec8f7a36f10408b4db324a9919518f020101";
	public static const START_ENCRYPTING_MSG:String = "startEncryptingMsg";
	public static const END_ENCRYPTING_MSG:String = "startEncryptingMsg";

	private static const AES_TYPE:String = "aes-256-cbc";
	private static const ADDITIONAL_KEY:String = "geheimnisschutzagent";

	//--------------------------------------
	//  encryptionKey
	//--------------------------------------
	private var _encryptionKey:String;
	public function get encryptionKey():String {return _encryptionKey;}

	public function encryptText(text:String):String {
		if (!text) return "";

		var inputBA:ByteArray = Hex.toArray(Hex.fromString(text));
		inputBA = encrypt(inputBA);
		return Base64.encodeByteArray(inputBA) || "";
	}

	public function encryptRandomText():String {
		if (!RANDOM_TEXT) return "";

		var inputBA:ByteArray = Hex.toArray(Hex.fromString(RANDOM_TEXT));
		inputBA = encrypt(inputBA);
		return Base64.encodeByteArray(inputBA) || "";
	}

	public function encrypt(bytes:ByteArray):ByteArray {
		if (!bytes) return new ByteArray();
		if (!encryptionKey) throw new Error("Empty encryptionKey!");

		var key:ByteArray = Hex.toArray(Hex.fromString(encryptionKey));
		var pad:IPad = new NullPad();
		var aes:ICipher = Crypto.getCipher(AES_TYPE, key, pad);
		var ivmode:IVMode = aes as IVMode;
		ivmode.IV = Hex.toArray(Hex.fromString(ADDITIONAL_KEY));
		aes.encrypt(bytes);
		return bytes;
	}

	public function decryptText(encryptedText:String):String {
		if (!encryptedText) return "";

		var data:ByteArray = Base64.decodeToByteArray(encryptedText);
		data = decrypt(data);
		return Hex.toString(Hex.fromArray(data));
	}

	public function decrypt(encryptedBytes:ByteArray):ByteArray {
		if (!encryptedBytes) return new ByteArray();
		if (!encryptionKey) throw new Error("Empty encryptionKey!");

		var key:ByteArray = Hex.toArray(Hex.fromString(encryptionKey));
		var pad:IPad = new NullPad();
		var aes:ICipher = Crypto.getCipher(AES_TYPE, key, pad);
		var ivmode:IVMode = aes as IVMode;
		ivmode.IV = Hex.toArray(Hex.fromString(ADDITIONAL_KEY));
		aes.decrypt(encryptedBytes);
		return encryptedBytes;
	}

	private var progressTimer:Timer;
	private var encryptedKeyBytes:ByteArray;
	private var encryptIterationNum:uint = 0;
	private var maxIterations:uint = 1;
	private var sha256:SHA256 = new SHA256();
	private var encryptCompleteCallback:Function;
	public function createEncryptionKey(pwd:String, privacyLevel:uint, completeCallback:Function):void {
		if (!progressTimer) {
			progressTimer = new Timer(50);
			progressTimer.addEventListener(TimerEvent.TIMER, encryptIteration);
		}
		if (!progressTimer.running) {
			var input:ByteArray = new ByteArray();
			input.writeUTFBytes(pwd);

			encryptedKeyBytes = sha256.hash(input);
			encryptIterationNum = 1;
			maxIterations = privacyLevel;
			encryptCompleteCallback = completeCallback;
			progressTimer.start();
			sendMessage(START_ENCRYPTING_MSG);
		}
	}

	private function encryptIteration(event:TimerEvent):void {
		if (encryptIterationNum >= maxIterations) {
			progressTimer.stop();
			_encryptionKey = encryptedKeyBytes.toString();
			encryptCompleteCallback();
			sendMessage(END_ENCRYPTING_MSG);
		}
		else {
			var total:int = 0;
			for (encryptIterationNum; encryptIterationNum < maxIterations && total < 200; encryptIterationNum++, total++) {
				encryptedKeyBytes = sha256.hash(encryptedKeyBytes);
			}
		}
	}

	public function deleteEncryptionKey():void {
		_encryptionKey = "";
	}

}
}
